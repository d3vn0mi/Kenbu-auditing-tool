{% extends "base.html" %}
{% block title %}Audit: {{ session.target_name }} - Kenbu{% endblock %}
{% block content %}
<!-- Breadcrumb -->
<nav class="flex mb-4" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li><a href="{{ url_for('audits.list_audits') }}" class="hover:text-gray-700">Audits</a></li>
        <li><span class="mx-1">/</span></li>
        <li class="text-gray-900 font-medium">{{ session.target_name }}</li>
    </ol>
</nav>

<!-- Header -->
<div class="mb-6 flex items-start justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">{{ session.target_name }}</h1>
        <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
            <span>{{ session.benchmark.name }}</span>
            {% if session.target_ip %}<span>{{ session.target_ip }}</span>{% endif %}
            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium {% if session.status == 'completed' %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                {{ session.status.replace('_', ' ').title() }}
            </span>
        </div>
    </div>
    <div class="flex space-x-3">
        <a href="{{ url_for('export.export_audit', session_id=session.id) }}" hx-boost="false"
           class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
            <svg class="mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Export
        </a>
        {% if session.status == 'in_progress' %}
        <form method="POST" action="{{ url_for('audits.complete_session', session_id=session.id) }}" hx-boost="false">
            <button type="submit" class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500"
                    onclick="return confirm('Mark this audit as complete?')">
                Complete Audit
            </button>
        </form>
        {% endif %}
    </div>
</div>

<!-- Progress Stats -->
<div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-6">
    <div class="bg-white shadow rounded-lg p-4 text-center">
        <p class="text-2xl font-bold text-gray-900">{{ results|length }}</p>
        <p class="text-xs text-gray-500">Total</p>
    </div>
    <div class="bg-white shadow rounded-lg p-4 text-center">
        <p class="text-2xl font-bold text-green-600">{{ session.pass_count }}</p>
        <p class="text-xs text-gray-500">Pass</p>
    </div>
    <div class="bg-white shadow rounded-lg p-4 text-center">
        <p class="text-2xl font-bold text-red-600">{{ session.fail_count }}</p>
        <p class="text-xs text-gray-500">Fail</p>
    </div>
    <div class="bg-white shadow rounded-lg p-4 text-center">
        <p class="text-2xl font-bold text-gray-500">{{ session.na_count }}</p>
        <p class="text-xs text-gray-500">N/A</p>
    </div>
    <div class="bg-white shadow rounded-lg p-4 text-center">
        <p class="text-2xl font-bold text-primary-600">{{ session.progress }}%</p>
        <p class="text-xs text-gray-500">Progress</p>
    </div>
</div>

<!-- Progress Bar -->
<div class="mb-6">
    <div class="w-full bg-gray-200 rounded-full h-3">
        <div class="bg-primary-600 h-3 rounded-full transition-all" style="width: {{ session.progress }}%"></div>
    </div>
</div>

<!-- Checklist -->
<div class="bg-white shadow rounded-lg overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24">Check #</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase w-16">Level</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase w-32">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-48">Finding</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase w-16">View</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for result in results %}
            <tr id="result-{{ result.id }}" class="{% if result.status == 'pass' %}bg-green-50{% elif result.status == 'fail' %}bg-red-50{% elif result.status == 'not_applicable' %}bg-gray-50{% endif %}">
                {% include 'audits/_result_row.html' %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if session.notes %}
<div class="mt-6 bg-white shadow rounded-lg p-4">
    <h3 class="text-sm font-semibold text-gray-900 mb-2">Session Notes</h3>
    <p class="text-sm text-gray-700">{{ session.notes }}</p>
</div>
{% endif %}
{% endblock %}
